<!DOCTYPE html>
<html lang="en">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Tracking</title>    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dark-theme-fixes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="data-mapper.js" defer></script>
    <script src="tracking-utils.js" defer></script>
    <script src="tracking.js" defer></script>
    <style>
        .tracking-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tracking-container h1 {
            color: var(--heading-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .tracking-container h2 {
            color: var(--heading-color);
            margin-top: 0;
        }
        
        .tracking-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
            color: var(--heading-color);
        }.tracking-info {
            background: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
            color: var(--text-color);
        }        .tracking-details {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .tracking-details h3 {
            color: var(--accent-color);
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        
        .tracking-details strong {
            color: var(--heading-color);
        }
        .tracking-timeline {
            margin-top: 30px;
        }
        .timeline-item {
            display: flex;
            margin-bottom: 20px;
            position: relative;
        }        .timeline-item:before {
            content: '';
            position: absolute;
            top: 24px;
            bottom: -20px;
            left: 10px;
            width: 2px;
            background-color: #444;
        }
        .timeline-item:last-child:before {
            display: none;
        }        .timeline-dot {
            width: 20px;
            height: 20px;
            background-color: var(--accent-color);
            border-radius: 50%;
            margin-right: 15px;
            margin-top: 2px;
            flex-shrink: 0;
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2);
        }        .timeline-content {
            flex-grow: 1;
            background: rgba(42, 42, 42, 0.5);
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
        }
        
        .timeline-content h4 {
            color: var(--heading-color);
            margin-top: 0;
            margin-bottom: 5px;
        }
        
        .timeline-content p {
            margin-bottom: 0.5em;
        }
        
        .timeline-date {
            color: #aaa;
            font-size: 0.85rem;
        }.back-button {
            display: inline-block;
            padding: 8px 16px;
            background: var(--btn-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-decoration: none;
            margin-top: 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.2s ease;
        }
        
        .back-button:hover {
            background: var(--btn-hover-gradient);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        /* Status styling */
        .status-delivered {
            color: #43a047;
            font-weight: bold;
        }
        .status-transit {
            color: #1976d2;
            font-weight: bold;
        }
        .status-out-for-delivery {
            color: #ff9800;
            font-weight: bold;
        }
        .status-processing {
            color: #9c27b0;
            font-weight: bold;
        }
        .status-pending {
            color: #757575;
            font-weight: bold;
        }
        .status-returned, .status-cancelled {
            color: #e53935;
            font-weight: bold;
        }
        
        /* New status badge styling */
        .status-badge {
            display: inline-block;
            margin-bottom: 15px;
            background: rgba(42, 42, 42, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            border-left: 4px solid var(--accent-color);
        }
        
        .status-badge p {
            margin: 0;
            font-size: 16px;
        }
        .tracking-update-form {
            margin-top: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #444;
        }
        #status-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #333;
            color: var(--text-color);
            margin-right: 10px;
        }        #update-status-btn {
            padding: 8px 16px;
            background: var(--btn-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        #update-status-btn:hover {
            background: var(--btn-hover-gradient);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .tracking-timeline h3, .status-update-form h3 {
            color: var(--accent-color);
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .quick-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: var(--btn-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .action-btn:hover {
            background: var(--btn-hover-gradient);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        /* Additional styling for estimated delivery */
        .estimated-delivery {
            background: rgba(255, 235, 59, 0.1);
            color: #333;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .estimated-delivery i {
            color: #fbc02d;
        }
    </style>
</head>
<body>
    <div class="tracking-container">
        <div class="tracking-header">
            <h1>Shipment Tracking</h1>
        </div>
        
        <div class="tracking-info">            <h2>Tracking Number: <span id="tracking-id">Loading...</span></h2>
            
            <div class="quick-actions">
                <button id="copy-tracking-btn" title="Copy Tracking ID" class="action-btn">
                    <i class="fas fa-copy"></i> Copy ID
                </button>
                <button id="share-tracking-btn" title="Share Tracking Link" class="action-btn">
                    <i class="fas fa-share-alt"></i> Share
                </button>
                <button id="print-tracking-btn" title="Print Tracking Details" class="action-btn">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
            
            <div class="status-badge">
                <p>Status: <span id="shipment-status">Loading...</span></p>
            </div>
            
            <div id="estimated-delivery" class="estimated-delivery" style="display:none;">
                <i class="fas fa-calendar-alt"></i> 
                Estimated Delivery: <span id="delivery-date">Not available</span>
            </div>
              <div class="tracking-details">
                <div>
                    <h3>Shipment Information</h3>
                    <p><strong>Package Type:</strong> <span id="package-type">Loading...</span></p>
                    <p><strong>Weight:</strong> <span id="package-weight">Loading...</span></p>
                    <p><strong>Created:</strong> <span id="created-date">Loading...</span></p>
                </div>
                <div>
                    <h3>Delivery Information</h3>
                    <p><strong>Recipient:</strong> <span id="recipient-name">Loading...</span></p>
                    <p><strong>Delivery Address:</strong> <span id="delivery-address">Loading...</span></p>
                    <p><strong>Special Instructions:</strong> <span id="special-instructions">None</span></p>
                </div>
            </div>
            
            <div id="current-location-section" class="current-location-section" style="display:none;">
                <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                <p id="current-address">Loading...</p>
            </div>
            
            <div class="tracking-timeline">
                <h3>Tracking Timeline</h3>
                <div id="timeline-container">
                    <p>Loading tracking information...</p>
                </div>
            </div>              <!-- Status update form (only visible to handlers/admin) -->
            <div id="status-update-section" class="status-update-form" style="display:none;">
                <h3>Update Shipment Status</h3>
                <div class="status-form-group">
                    <label for="status-select">Status:</label>
                    <select id="status-select">
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="In Transit">In Transit</option>
                        <option value="Out for Delivery">Out for Delivery</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Returned">Returned</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="status-form-group">
                    <label for="current-address-input">Current Location:</label>
                    <input type="text" id="current-address-input" placeholder="Enter current location" />
                </div>
                
                <button id="update-status-btn">Update Status</button>
            </div>
        </div>
        
        <a href="javascript:history.back()" class="back-button">Back</a>
    </div>    <script>        document.addEventListener('DOMContentLoaded', async function() {
            // Get shipment ID from URL - handle multiple URL formats
            const urlParams = new URLSearchParams(window.location.search);
            let shipmentId = urlParams.get('id');
            let trackingId = urlParams.get('tracking');
            
            console.log("Initial URL params:", { shipmentId, trackingId });
            
            // Handle direct URL format from QR codes
            const pathParts = window.location.pathname.split('/');
            const lastPathPart = pathParts[pathParts.length - 1];
            
            // Check various URL patterns
            // Case 1: URL path contains 'track' folder, like /track/PT-2505-OKX4G0
            if (pathParts.includes('track')) {
                const trackPosition = pathParts.indexOf('track');
                if (trackPosition >= 0 && trackPosition < pathParts.length - 1) {
                    trackingId = pathParts[trackPosition + 1];
                    console.log('Detected tracking ID after /track/:', trackingId);
                }
            } 
            // Case 2: Direct tracking ID in path like /PT-2505-OKX4G0 or PT-2505-OKX4G0.html
            else if (lastPathPart.match(/^[A-Z]{2}-\d{4}-[A-Z0-9]{5,6}(\.html)?$/)) {
                trackingId = lastPathPart.replace('.html', '');
                console.log('Detected tracking ID in path:', trackingId);
            }
              // Case 3: QR code might have scanned as full URL like https://yourapp.com/track/PT-2505-OKX4G0
            if (!trackingId && !shipmentId) {
                // Check if the URL might be in the hash part (can happen with some QR scanners)
                const hashValue = window.location.hash.substring(1);
                if (hashValue) {
                    if (hashValue.match(/^[A-Z]{2}-\d{4}-[A-Z0-9]{5,6}$/)) {
                        trackingId = hashValue;
                        console.log('Found tracking ID in hash:', trackingId);
                    } else if (hashValue.includes('/track/')) {
                        trackingId = hashValue.split('/track/').pop();
                        console.log('Found tracking ID in hash path:', trackingId);
                    } else if (hashValue.toLowerCase().includes('/api/shipment/tracking/')) {
                        // Handle backend API URL pattern in hash
                        trackingId = hashValue.split('/api/shipment/tracking/').pop().split('?')[0].split('#')[0];
                        console.log('Found tracking ID in hash from API URL:', trackingId);
                    }
                }
                
                // Handle case where the full backend API URL was passed directly in the URL
                const fullUrl = window.location.toString();
                if (fullUrl.toLowerCase().includes('/api/shipment/tracking/')) {
                    const matches = fullUrl.match(/\/api\/shipment\/tracking\/([A-Z0-9\-]+)/i);
                    if (matches && matches.length > 1) {
                        trackingId = matches[1];
                        console.log('Extracted tracking ID from API URL in full URL:', trackingId);
                    }
                }
            }
            
            console.log("Final tracking parameters:", { shipmentId, trackingId });
            
            // Set up action buttons
            const copyBtn = document.getElementById('copy-tracking-btn');
            const shareBtn = document.getElementById('share-tracking-btn');
            const printBtn = document.getElementById('print-tracking-btn');
            
            copyBtn.addEventListener('click', function() {
                const trackingIdText = document.getElementById('tracking-id').textContent;
                copyTrackingId(trackingIdText);
            });
            
            shareBtn.addEventListener('click', function() {
                const trackingIdText = document.getElementById('tracking-id').textContent;
                shareTracking(trackingIdText);
            });
            
            printBtn.addEventListener('click', function() {
                // Get current shipment data from sessionStorage or reconstruct it from page
                const cachedShipment = sessionStorage.getItem('lastTrackedShipment');
                if (cachedShipment) {
                    generatePrintView(JSON.parse(cachedShipment));
                } else {
                    // Create a simplified shipment object from the page data
                    const shipmentFromPage = {
                        trackingId: document.getElementById('tracking-id').textContent,
                        status: document.getElementById('shipment-status').textContent,
                        packageType: document.getElementById('package-type').textContent,
                        weight: document.getElementById('package-weight').textContent,
                        recipientName: document.getElementById('recipient-name').textContent,
                        deliveryAddress: document.getElementById('delivery-address').textContent,
                        specialInstructions: document.getElementById('special-instructions').textContent,
                        createdAt: document.getElementById('created-date').textContent,
                        currentAddress: document.getElementById('current-address') ? 
                            document.getElementById('current-address').textContent : null
                    };
                    generatePrintView(shipmentFromPage);
                }
            });
            
            if (!shipmentId && !trackingId) {
                alert('No shipment or tracking ID provided');
                window.location.href = 'index.html';
                return;
            }            // Check if user is logged in
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            
            // Detect if we came from a QR code scan
            const isFromQRScan = !urlParams.has('source') && 
                                 (window.location.pathname.includes('/track/') || 
                                  window.location.pathname.match(/\/[A-Z]{2}-\d{4}-[A-Z0-9]{5,6}(\.html)?$/));
            
            // Check if this page was accessed from the home page tracking form
            const fromHomePage = urlParams.has('source') && urlParams.get('source') === 'homeTracking';
            const isFromHomeTracking = fromHomePage || (urlParams.has('tracking') && !isFromQRScan);
            
            // If it's a handler/admin scanning QR OR logged in from dashboard, allow status updates
            const canUpdateStatus = currentUser.role && 
                (currentUser.role.toLowerCase() === 'handler' || currentUser.role.toLowerCase() === 'admin');
            
            if (canUpdateStatus) {
                document.getElementById('status-update-section').style.display = 'block';
            }
            
            // Show loading indicators throughout the page
            document.getElementById('tracking-id').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('shipment-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('package-type').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('package-weight').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('recipient-name').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('delivery-address').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('created-date').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            let shipment;
              try {
                // Fetch shipment details based on available ID
                if (trackingId) {
                    console.log('Attempting to fetch by tracking ID:', trackingId);
                    const result = await trackShipment(trackingId);
                    if (!result.success) {
                        throw new Error(result.error);
                    }
                    shipment = result.shipment;
                    
                    // Store the actual tracking ID for updates
                    sessionStorage.setItem('currentTrackingId', trackingId);
                    
                    // Log if we used the cached result for debugging
                    if (result.cached) {
                        console.log('Using cached shipment data');
                    }                } else if (shipmentId) {
                    console.log('Attempting to fetch by shipment ID:', shipmentId);
                    
                    // First try using the tracking endpoint if it looks like a tracking ID
                    if (shipmentId.match(/^[A-Z]{2}-\d{4}-[A-Z0-9]{5,6}$/)) {
                        console.log('ID appears to be a tracking ID, using tracking endpoint');
                        const result = await trackShipment(shipmentId);
                        if (result.success) {
                            shipment = result.shipment;
                            // Store as tracking ID since we used that endpoint
                            sessionStorage.setItem('currentTrackingId', shipmentId);
                        } else {
                            // Fall back to regular endpoint if tracking endpoint fails
                            const response = await fetch(`https://localhost:5001/api/Shipment/${shipmentId}`);
                            if (!response.ok) {
                                throw new Error('Failed to fetch shipment');
                            }
                            shipment = await response.json();
                            sessionStorage.setItem('currentShipmentId', shipmentId);
                        }
                    } else {
                        // Use regular endpoint for numeric IDs
                        const response = await fetch(`https://localhost:5001/api/Shipment/${shipmentId}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch shipment');
                        }
                        shipment = await response.json();
                        sessionStorage.setItem('currentShipmentId', shipmentId);
                    }
                } else {
                    throw new Error('No tracking or shipment ID provided');
                }// Log the shipment data we received for debugging
                console.log('Shipment data to display:', shipment);
                
                // Populate the tracking page with shipment details using our new function
                displayTrackingInfo(shipment);
                
                // Get created date based on multiple possible field names
                const dateField = shipment.createdAt || shipment.created || shipment.date || shipment.created;
                const createdDate = dateField ? new Date(dateField).toLocaleString() : 'N/A';
                
                // Create tracking timeline
                const timelineContainer = document.getElementById('timeline-container');
                timelineContainer.innerHTML = '';
                
                // Add shipment creation as first timeline event
                addTimelineEvent(timelineContainer, 'Shipment Created', createdDate, 
                    'Your shipment has been registered in our system.');
                  // If there are tracking events in the shipment data, show them in the timeline
                if (shipment.trackingEvents && Array.isArray(shipment.trackingEvents) && shipment.trackingEvents.length > 0) {
                    // Sort events by date if available
                    const sortedEvents = [...shipment.trackingEvents].sort((a, b) => {
                        return new Date(a.timestamp || 0) - new Date(b.timestamp || 0);
                    });
                    
                    // Add each tracking event to the timeline
                    sortedEvents.forEach(event => {
                        const eventDate = event.timestamp ? new Date(event.timestamp).toLocaleString() : 'N/A';
                        addTimelineEvent(
                            timelineContainer, 
                            event.status || 'Status Update', 
                            eventDate,
                            event.description || getStatusDescription(event.status),
                            event.location || null
                        );
                    });
                } else {
                    // If no tracking events, just add current status as an event
                    // Use the status from the shipment or default to "Pending" if not available
                    const status = shipment.status || 'Pending';
                    addTimelineEvent(
                        timelineContainer, 
                        status, 
                        'Current', 
                        getStatusDescription(status),
                        shipment.currentAddress || null
                    );
                }                // Set up status update functionality only if it's visible
                if (document.getElementById('status-update-section').style.display !== 'none') {
                    // Set initial values based on current shipment data
                    document.getElementById('status-select').value = shipment.status || 'Pending';
                    
                    // If we have current address, pre-fill the input
                    if (shipment.currentAddress && shipment.currentAddress !== 'In Transit' && shipment.currentAddress !== 'N/A') {
                        document.getElementById('current-address-input').value = shipment.currentAddress;
                    }
                      document.getElementById('update-status-btn').addEventListener('click', async () => {
                        try {
                            const newStatus = document.getElementById('status-select').value;
                            const btn = document.getElementById('update-status-btn');
                            
                            // Show loading state
                            const originalBtnText = btn.textContent;
                            btn.textContent = 'Updating...';
                            btn.disabled = true;
                            
                            // Use tracking ID if that's what we have, otherwise use shipment ID
                            // The updateShipmentStatus function will handle cleaning up the ID
                            const idForUpdate = trackingId || shipmentId;
                            await updateShipmentStatus(idForUpdate, newStatus);
                            
                            // Reset button after success (the page will reload soon)
                            btn.textContent = 'Success!';
                            setTimeout(() => {
                                btn.textContent = originalBtnText;
                                btn.disabled = false;
                            }, 1000);
                        } catch (error) {
                            console.error('Failed to update status:', error);
                            alert('Failed to update status. Please try again.');
                        }
                    });
                }
                  } catch (error) {
                console.error('Error fetching shipment details:', error);
                
                // Instead of alert, show error on page
                document.getElementById('tracking-id').textContent = 'Error';
                document.getElementById('shipment-status').textContent = 'Not found';
                document.getElementById('package-type').textContent = 'N/A';
                document.getElementById('package-weight').textContent = 'N/A';
                document.getElementById('recipient-name').textContent = 'N/A';
                document.getElementById('delivery-address').textContent = 'N/A';
                document.getElementById('created-date').textContent = 'N/A';
                document.getElementById('special-instructions').textContent = 'N/A';
                
                // Show a more helpful error message in timeline
                const timelineContainer = document.getElementById('timeline-container');
                timelineContainer.innerHTML = `
                    <div class="timeline-error" style="background: rgba(229, 57, 53, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #e53935;">
                        <h4 style="color: #e53935; margin-top: 0;">Error Loading Tracking Information</h4>
                        <p>We couldn't find tracking information for the provided tracking number. This could be due to:</p>
                        <ul>
                            <li>An incorrect tracking number</li>
                            <li>The shipment has not been processed yet</li>
                            <li>A temporary server issue</li>
                        </ul>
                        <p>Please verify your tracking number and try again, or contact support if the issue persists.</p>
                        <a href="index.html" class="back-button" style="display: inline-block; margin-top: 10px;">Go Back to Tracking</a>
                    </div>
                `;
            }
        });
          // Helper function to add timeline events to the container
        function addTimelineEvent(container, status, date, description, location = null) {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            
            let locationHtml = '';
            if (location) {
                locationHtml = `<p class="timeline-location"><i class="fas fa-map-marker-alt"></i> ${location}</p>`;
            }
            
            timelineItem.innerHTML = `
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <h4>${status}</h4>
                    <p class="timeline-date">${date}</p>
                    ${locationHtml}
                    <p>${description}</p>
                </div>
            `;
            
            container.appendChild(timelineItem);
        }
        
        // Get description for status
        function getStatusDescription(status) {
            const descriptions = {
                'Pending': 'Your shipment has been created and is awaiting processing.',
                'Processing': 'We are preparing your shipment for delivery.',
                'In Transit': 'Your shipment is on its way to the destination.',
                'Out for Delivery': 'Your shipment will be delivered today.',
                'Delivered': 'Your shipment has been successfully delivered.',
                'Returned': 'The shipment has been returned to the sender.',
                'Cancelled': 'The shipment has been cancelled.'
            };
            
            return descriptions[status] || 'Status update received.';
        }        // Update shipment status function
        async function updateShipmentStatus(shipmentId, newStatus) {
            try {
                // Get current address if provided
                const currentAddress = document.getElementById('current-address-input').value.trim();
                
                // Get the stored tracking or shipment ID (which might be different from what's in the URL)
                const storedTrackingId = sessionStorage.getItem('currentTrackingId');
                const storedShipmentId = sessionStorage.getItem('currentShipmentId');
                
                // Prefer the stored IDs since those were used successfully to fetch the data
                const idToUse = shipmentId || storedTrackingId || storedShipmentId;
                
                // Clean up ID to remove any URL parts (especially important for QR code paths)
                const cleanId = idToUse.includes('/') ? idToUse.split('/').pop() : idToUse;
                
                console.log('Updating status using ID:', cleanId);
                  // Always use the tracking endpoint for tracking-style IDs (PT-XXXX-XXXXX format)
                const hasTrackingIdFormat = cleanId && cleanId.match(/^[A-Z]{2}-\d{4}-[A-Z0-9]{5,6}$/);
                
                // Always prefer the tracking endpoint if the ID looks like a tracking ID
                let endpoint;
                
                if (hasTrackingIdFormat) {
                    // IDs with tracking format always use the tracking endpoint
                    console.log('Using tracking ID endpoint for status update');
                    endpoint = `https://localhost:5001/api/Shipment/tracking/${cleanId}/status`;
                } else if (storedTrackingId) {
                    // If we have a stored tracking ID, use that
                    console.log('Using stored tracking ID for status update');
                    endpoint = `https://localhost:5001/api/Shipment/tracking/${storedTrackingId}/status`;
                } else {
                    // Otherwise use regular shipment ID endpoint
                    console.log('Using shipment ID endpoint for status update');
                    endpoint = `https://localhost:5001/api/Shipment/${cleanId}/status`;
                }
                
                // Log the final endpoint for debugging
                console.log('Final status update endpoint:', endpoint);
                
                // Prepare the request body with both status and current address
                const requestBody = {
                    status: newStatus,
                    currentAddress: currentAddress || null
                };
                
                const response = await fetch(endpoint, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}` // In case you need auth
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update status');
                }
                
                const updatedShipment = await response.json();
                
                // Update the cached shipment if it exists
                if (sessionStorage.getItem('lastTrackedShipment')) {
                    const cachedShipment = JSON.parse(sessionStorage.getItem('lastTrackedShipment'));
                    cachedShipment.status = newStatus;
                    
                    // Also update current address if provided
                    if (currentAddress) {
                        cachedShipment.currentAddress = currentAddress;
                    }
                    
                    sessionStorage.setItem('lastTrackedShipment', JSON.stringify(cachedShipment));
                }
                  // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'status-update-success';
                successMsg.textContent = `Shipment status updated to: ${newStatus}`;
                successMsg.style.backgroundColor = 'rgba(67, 160, 71, 0.2)';
                successMsg.style.color = '#4caf50';
                successMsg.style.padding = '10px';
                successMsg.style.marginTop = '10px';
                successMsg.style.borderRadius = '4px';
                successMsg.style.borderLeft = '3px solid #43a047';
                successMsg.style.animation = 'fadeIn 0.3s ease';
                
                document.getElementById('status-update-section').appendChild(successMsg);
                
                // Refresh the page after a short delay to show the updated status
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error('Error updating shipment status:', error);
                alert('Error updating shipment status. Please try again later.');
            }
        }
    </script>
</body>
</html>
